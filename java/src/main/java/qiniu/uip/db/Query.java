package qiniu.uip.db;

import qiniu.uip.db.format.Formats;
import qiniu.uip.db.format.QueryBuilder;
import qiniu.uip.db.format.ipdb.Ipdb;
import qiniu.uip.util.File;
import qiniu.uip.util.IPAddress;
import qiniu.uip.util.Strings;

import java.io.IOException;

public final class Query {
    static {
        Formats.registerQueryFormat(".ipdb", new Ipdb.Builder());
    }

    private qiniu.uip.db.format.Query q;

    private Query(qiniu.uip.db.format.Query q) {
        this.q = q;
    }

    public static Query create(String filename) throws IOException {
        String ext = filename.substring(filename.lastIndexOf("."));
        byte[] data = File.readAll(filename);
        return create(data, ext);
    }

    public static Query create(byte[] data, String format) throws InvalidDatabaseException {
        QueryBuilder qb = Formats.getQueryFormat(format);
        if (qb == null) {
            throw new InvalidDatabaseException("not support format");
        }
        Query q = new Query(qb.build(data));
        if (q.version().hasIpV4()) {
            String[] list = iplist.split(" ");
            byte[][] ips = new byte[list.length][];
            for (int i = 0; i < list.length; i++) {
                ips[i] = IPAddress.textToNumericFormatV4(list[i]);
            }
            q.q.buildCache(ips);
        }
        return q;
    }

    public IpInfo query(String addr) throws IPFormatException, InvalidDatabaseException {
        byte[] ipv;
        if (Strings.isEmpty(addr)) {
            throw new IPFormatException("ip is empty");
        }

        if (addr.indexOf(":") > 0) {
            ipv = IPAddress.textToNumericFormatV6(addr);
            if (ipv == null) {
                throw new IPFormatException("ipv6 format error");
            }

        } else if (addr.indexOf(".") > 0) {
            ipv = IPAddress.textToNumericFormatV4(addr);
            if (ipv == null) {
                throw new IPFormatException("ipv4 format error");
            }
        } else {
            throw new IPFormatException("ip format error");
        }
        return query(ipv);
    }

    public IpInfo query(byte[] addr) throws IPFormatException, InvalidDatabaseException {
        return q.query(addr);
    }

    public VersionInfo version() {
        return q.version();
    }

    final static String iplist ="111.192.0.0 101.80.0.0 10.0.0.0 117.8.0.0 120.244.0.0 117.143.0.0 222.209.0.0 36.44.0.0 175.167.128.0 180.98.32.0 223.88.0.0 115.192.0.0 112.41.0.0 27.18.0.0 111.32.0.0 119.130.0.0 112.224.0.0 106.114.0.0 115.60.0.0 112.36.128.0 121.225.0.0 117.147.0.0 113.88.0.0 119.53.0.0 112.224.64.0 36.5.0.0 223.64.0.0 27.190.0.0 39.185.0.0 1.62.0.0 49.93.0.0 125.80.0.0 113.226.0.0 223.65.0.0 223.80.0.0 223.102.0.0 106.34.128.0 27.186.0.0 39.144.138.0 221.192.176.0 183.198.80.0 183.9.224.0 36.48.0.0 111.25.0.0 111.41.160.0 223.104.103.0 30.0.0.0 112.32.0.0 223.79.192.0 111.18.128.0 183.226.0.0 101.18.0.0 117.151.0.0 112.22.64.0 115.171.0.0 115.214.0.0 27.189.0.0 223.91.64.0 182.104.64.0 114.224.0.0 121.20.0.0 183.197.160.0 175.146.0.0 106.47.0.0 112.21.64.0 120.230.96.0 120.208.96.0 182.200.0.0 27.216.0.0 112.8.32.0 112.97.48.0 139.226.0.0 112.12.128.0 120.10.0.0 36.28.128.0 112.102.0.0 39.190.128.0 223.66.128.0 110.251.0.0 117.136.79.0 223.102.96.0 39.130.64.0 116.52.0.0 122.137.0.0 111.37.224.0 113.77.0.0 36.132.216.0 117.136.67.0 183.197.144.0 223.11.0.0 27.214.0.0 223.91.0.0 124.89.84.0 117.86.0.0 120.228.64.0 39.183.128.0 223.88.128.0 42.91.0.0 183.197.48.0 124.238.0.0 117.136.100.0 120.229.64.0 113.246.0.0 114.228.0.0 120.36.0.0 123.11.0.0 112.96.160.0 223.91.192.0 112.38.32.0 111.25.64.0 171.116.0.0 183.216.0.0 113.70.0.0 42.224.0.0 114.234.0.0 182.123.0.0 116.136.217.0 223.104.216.0 112.21.224.0 223.96.64.0 58.243.248.0 111.36.0.0 122.238.0.0 117.91.0.0 117.136.32.0 116.136.212.0 39.171.128.0 123.168.64.0 122.96.32.0 60.180.0.0 112.49.0.0 223.98.32.0 223.89.128.0 120.216.192.0 111.36.112.0 120.229.128.0 175.151.0.0 112.233.0.0 223.101.96.0 180.126.0.0 112.32.192.0 39.184.0.0 49.118.0.0 112.40.32.0 112.22.32.0 222.135.0.0 36.63.0.0 1.61.0.0 106.115.0.0 171.218.192.0 113.57.0.0 112.47.0.0 116.8.32.0 183.199.160.0 1.180.0.0 113.127.0.0 60.9.0.0 223.67.192.0 223.89.192.0 42.85.192.0 175.175.160.0 182.124.0.0 113.239.0.0 61.137.128.0 112.242.0.0 36.63.128.0 110.7.128.0 27.198.0.0 126.0.0.0 39.75.0.0 120.36.128.0 223.90.128.0 120.8.0.0 110.81.0.0 183.217.192.0 42.239.64.0 123.185.0.0 182.123.128.0 223.107.192.0 223.68.64.0 183.197.8.0 223.90.192.0 112.48.0.0 153.34.0.0 60.218.0.0 183.199.240.0 123.180.0.0 183.199.64.0 5.88.0.0 111.35.240.0 116.162.0.0 1.26.32.0 114.233.0.0 123.144.0.0 36.43.96.0 112.43.0.0 117.136.57.0 223.90.0.0 120.242.0.0 43.250.200.0 112.37.192.0 122.157.128.0 111.18.48.0 117.61.16.0 116.26.0.0 106.118.64.0 223.90.64.0 36.56.0.0 223.88.192.0 112.97.160.0 120.16.0.0 36.113.96.0 61.158.146.0 175.165.128.0 117.92.0.0 112.20.192.0 223.101.160.0 183.212.0.0 223.102.240.0 111.17.0.0 123.186.0.0 120.242.64.0 175.147.128.0 115.53.64.0 125.126.0.0 117.136.7.0 116.112.32.0 120.14.0.0 60.22.64.0 117.90.0.0 111.41.208.0 111.49.64.0 175.153.160.0 223.104.102.0 117.151.128.0 175.148.128.0 117.136.72.0 60.183.0.0 223.101.224.0 117.150.32.0 106.96.0.0 117.148.64.0 60.7.0.0 113.73.0.0 219.144.0.0 36.104.16.0 123.180.192.0 124.239.32.0 112.97.208.0 123.179.96.0 180.125.0.0 120.235.40.0 123.167.0.0 221.206.0.0 124.160.128.0 36.62.0.0 113.128.0.0 203.168.0.0 36.46.96.0 42.239.0.0 60.220.0.0 183.219.0.0 120.243.0.0 112.39.32.0 27.149.0.0 223.198.112.0 140.75.128.0 42.234.0.0 39.152.192.0 106.118.128.0 223.102.160.0 112.41.176.0 115.152.0.0 119.50.0.0 111.18.160.0 223.150.0.0 27.26.0.0 117.171.160.0 123.172.144.0 59.55.0.0 183.197.120.0 39.70.0.0 117.65.128.0 36.62.128.0 39.144.64.0 183.165.64.0 113.83.0.0 222.140.128.0 175.148.0.0 223.104.48.0 36.28.0.0 99.224.0.0 123.168.192.0 36.142.176.0 27.200.0.0 114.101.128.0 111.41.240.0 110.254.0.0 117.152.160.0 223.101.192.0 114.239.0.0 1.204.0.0 139.211.192.0 106.18.64.0 27.27.0.0 111.41.224.0 116.171.240.0 220.200.0.0 139.214.160.0 123.129.64.0 39.81.0.0 1.59.128.0 124.116.192.0 171.40.0.0 144.52.128.0 120.243.192.0 222.163.112.0 112.98.0.0 111.16.160.0 182.127.128.0 117.189.0.0 120.242.192.0 36.4.0.0 120.229.104.0 114.32.0.0 111.113.0.0 120.243.96.0 112.9.0.0 183.200.176.0 39.155.0.0 120.231.96.0";
}
